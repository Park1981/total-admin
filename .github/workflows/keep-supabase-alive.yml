name: Keep Supabase Database Alive

# 2ì¼ë§ˆë‹¤ ì •ì˜¤(UTC ê¸°ì¤€)ì— ì‹¤í–‰ = í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë°¤ 9ì‹œ
on:
  schedule:
    - cron: '0 12 */2 * *'  # 2ì¼ë§ˆë‹¤ UTC 12:00 (KST 21:00)

  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
  workflow_dispatch:

jobs:
  ping-database:
    runs-on: ubuntu-latest

    steps:
      - name: Ping Supabase Database
        run: |
          echo "ğŸ”” Pinging database to keep Supabase alive..."

          # Health check API í˜¸ì¶œ
          HEALTH_RESPONSE=$(curl -s -w "%{http_code}" \
            https://total-admin.onrender.com/healthz)

          echo "Health check response: $HEALTH_RESPONSE"

          # Keep-alive ì „ìš© ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
          KEEPALIVE_RESPONSE=$(curl -s -w "%{http_code}" \
            https://total-admin.onrender.com/keep-alive)

          echo "Keep-alive response: $KEEPALIVE_RESPONSE"

          # DB ì—°ê²° í…ŒìŠ¤íŠ¸ (ì‹¤ì œ Supabase ì¿¼ë¦¬)
          DB_RESPONSE=$(curl -s -w "%{http_code}" \
            https://total-admin.onrender.com/api/test-db)

          echo "Database test response: $DB_RESPONSE"

          # ë¡œê·¸ì¸ APIë¡œ ì‹¤ì œ DB ì¿¼ë¦¬ (ì˜ëª»ëœ ê³„ì •ì´ì§€ë§Œ DB ì—°ê²°ì€ ë¨)
          LOGIN_RESPONSE=$(curl -s -w "%{http_code}" \
            -X POST https://total-admin.onrender.com/api/employees/login \
            -H "Content-Type: application/json" \
            -d '{"username":"keepalive","password":"ping"}')

          echo "Login API response: $LOGIN_RESPONSE"

          echo "âœ… Database ping completed successfully!"
          echo "ğŸ• Timestamp: $(date)"
          echo "ğŸ“Š Next scheduled run: 4 days from now"

      - name: Log Success
        run: |
          echo "ğŸ¯ Keep-alive job completed successfully"
          echo "ğŸ”„ Supabase database connection maintained"
          echo "ğŸ“… Job executed on: $(date)"